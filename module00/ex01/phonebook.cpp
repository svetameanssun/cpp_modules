#include "phonebook.hpp"

void PhoneBook::initTheme(Color thm){
    theme = thm;
}

void PhoneBook::resetIntroTimes(){
    introTimes = 0;
}

void PhoneBook::addContact() {

    if((count) >= maxNum) {
        if(ind == maxNum) {
            std::cout << theme.getVibr() << "You reached the maximum number of contacts!\n"
                << "The oldest contact will be rewritten\n" << theme.getReset();
            ind = 0;
            try {
                contacts[ind].createContact(ind, theme);
            } catch(const EmptyInputException& err) {
                std::cerr << theme.getRed() << "Error: " << err.what() << theme.getReset() << std::endl;
                ind--;
            }   
        } else {
            std::cout << "The oldest contact will be rewritten\n";
            try {
                contacts[ind].createContact(ind, theme);
            } catch(const EmptyInputException& err) {
                std::cerr << theme.getRed() << "Error: " << err.what() << theme.getReset() << std::endl;
                ind--;
            }
        }
    } else {
        try {
            contacts[ind].createContact(ind, theme);
            
        } catch(const EmptyInputException& err) {
            std::cerr << theme.getRed() << "Error: " << err.what() << theme.getReset() << std::endl;
            count--;
            ind--;
        }
    }
    count++;
    ind++;
}

int PhoneBook::checkIndex(std::string input_str){
    
    const char * input_c_str;
    input_c_str = input_str.c_str();
    int i = 0;
    long int input_long;

    if (input_str.empty())
        return (-1);
    while(input_c_str[i])
    {
        if (!isdigit(input_c_str[i])){
            return (-1);
        }
        i++;
    }
	input_long = atol(input_c_str);
    if (input_long < maxNum && input_long >= count) // check this cond
    {
        return (-1);
    }
    if (input_long < 0 || input_long >= maxNum)
    {
        return (-1);
    }
    return ((int)input_long);
}

void PhoneBook::displayPhoneBook() {
    int i = 0;
    std::string input_str;
    if (ind == 0)
    {
        std::cout << theme.getVibr() << "The phone book is empty!\n" << theme.getReset();
        return ;
    }
    std::cout << "\n"<< theme.getCalm() << "|"
          << std::setw(10) << "Index" << "|"
          << std::setw(10) << "First Name" << "|"
          << std::setw(10) << "Last Name" << "|"
          << std::setw(10) << "Nickname" << "|"
          << std::endl;
    std::cout << std::string(45, '-') << theme.getReset() << std::endl;
    int res = (count < maxNum) ? count : maxNum;
	while(i < res) {
        contacts[i].showShortContact();
        i++;
    }
	std::cout << theme.getBold() << theme.getVibr()  <<"\n\nChoose index to see a contact:\n" << theme.getReset();
    std::cout << theme.getPale();
    getline(std::cin, input_str);
    std::cout << theme.getReset();
    res = checkIndex(input_str);
	if (res == -1)
    {
        std::cout << "\n";
        std::cout << theme.getRed() << "The wrong input! Introduce a digit that matches the indexes" << theme.getRed() << std::endl;
        displayPhoneBook();
        return;   
    }
	contacts[res].showLongContact();
}

void PhoneBook::phoneBookIntro()
{
    std::string girlArt =
    "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++*+++*++++++++++++++++++++++++++++++++++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++***##***++*++++++++++++++++++++++++++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++++++++++++++++++++++****########**###########*+++++++++++++++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++++++++++++++++++++****###%%%%%%%%%%%%@@%%%%%%@@%%%#**+++++++++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++++++++++++++++++****#####%%%%%%%%###%%%@%%%%%%%@%@@%#*++++++++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++++++++++++++++****###%%%%@%%%%%%%%%%%%%#%%#%%%%%%%%%@#++++++++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++++++++++++++*****#%@@@%%%%%%%%%%%%%%%#####%%%%%%%%%%%#++++++++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++++++++++++****#%%%##*****+++++++++*##%%%#%%%%%@@%@@@#++++++++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++++++++++*****#%%#***++++++++++====+++*#####%%%%%@@@@%#+++++++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++++++++******#%#*++++++================++**#%%%%%%%@@@%#*+++++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++++++*******##*+++========================++*#%%%%%%%%%%#+++++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++++++***+**##*+++============================+**##%%%%%%%%*++++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++++****+**%#*++================================+*###%%%%%%%*+++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++++****++##*+++==================================+*##%%%%%%%#+++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++***++*%%#*+===================---------=========+*#%%%%%%%#+++++++\n"
    "\t\t++++++++++++++++++++++++++++++++++**++****#%%#*================-----------=========+*#%%%%%%#*++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++***+##***+*##**+=========--==-------------========+*#%%%%%##*++++++\n"
    "\t\t+++++++++++++++++++++++++++++++++****#*#**+++***+==-===--------------------======++**%%%%##***++++++\n"
    "\t\t++++++++++++++++++++++++++++++++*#**%%%%%%%******===--=-==+==--------------======++*#%%%##***+++++++\n"
    "\t\t+++++++++++++++++++++++++++++++*#**#**#%#+#%%%#**+=---=*++**##*+=====-------====+++*##%%#**+++++++++\n"
    "\t\t++++++++++++++++++++++++++++++*#***++++******#***=---=*==++++*####**++=----=====++***#%%##***+++++++\n"
    "\t\t+++++++++++++++++++++++++++++*#***+==+++++++***+=---+#+==+++++++++++***==-======+***##%%%#*****+++++\n"
    "\t\t+++++++++++++++++++++++++++++##**+==========++====-*+===+****+=++=====+**=======+*#*##%%%##*+***++++\n"
    "\t\t++++++++++++++++++++++++++++###**+==========++====+====*#**##%##*++=====++======+#%###%%%##******+++\n"
    "\t\t+++++++++++++++++++++++++++*####+=========+++====*=-====+##++%@%%#++===========+*#%##%%%%%#*******++\n"
    "\t\t++++++++++++++++++++++++++*#####+=======++=======#===-====+******#%*+=========++#%%#%%%%%%##****++*+\n"
    "\t\t++++++++++++++++++++++++++*##*##++=====+**++======*==----====================++#%@%%%%%%%%%#****++++\n"
    "\t\t++++++++++++++++++++++++++######*++======***+++===+=-----============---====++#%@@@@%%%%%%%##****+++\n"
    "\t\t++++++++++++++++++++++++++*#####*+++===========+==+====-----=====-------====+*%%%%%%%%%%%%%%#***++++\n"
    "\t\t+++++++++++++++++++++++++*######*++++=+=====--=++======----------------=====+*%%##%%%%%%%%%###***+++\n"
    "\t\t+++++++++++++++++++++++++*######+++*##**+====+==--====---------------======+*#%%##%%%%%%%%%%%##****+\n"
    "\t\t+++++++++++++++++++++++++*###%#*++++++*##**++#===---==-------------=======+++*####%@%%%#%%%%#%##****\n"
    "\t\t+++++++++++++++++++++++++*###%%#***++++++*##*+*+==-=------------=====++++++=-::*#%%%%####%%%####****\n"
    "\t\t++++++++++++++++++++++++++##%%%%********++++**#**+===-----=========+++++++==::*%%%%%%##*#%%%####****\n"
    "\t\t++++++++++++++++++++++++++*#%%%%#*++++++#*+++++**##==============+++++@#%=:=@@@@@%%%%##*#%%######***\n"
    "\t\t++++++++++++++++++++++++++*#%%#%%*++++++*+++++++++++============+++++*@#%=:=@@@@@%%%%##*#%%######***\n"
    "\t\t+++++++++++++++++++++++++++*%%%#%#+++++#====+++++===============+++**@@@%#%@%%%%%%%%%##*#####%##****\n"
    "\t\t+++++++++++++++++++++++++++*##%%%%#*++**+=====================++**+*#@@*##@@@%%@%%%%###*###%###*****\n"
    "\t\t+++++++++++++++++++++++++++**##%%%%%%#**#*+==============++++*#*++**%%@**%@@%%%%%%%#*##**###********\n"
    "\t\t++++++++++++++++++++++++++***###%%%%%@@@%#******##########**++==++*#%%%%%%%%%%%%%#####*##***+++*****\n"
    "\t\t++++++++++++++++++++++++++***##*#%#%%%@@@@@@%###*******++======++*##%%%%%%%%%%%%#%###*###*++++++***+\n"
    "\t\t++++++++++++++++++++++*******#***#####%%@@@@%#***++++==========+*##%%%%%%%%#%##%#####%%%%##*********\n"
    "\t\t+++++++++++++++++++++++**###########**#%@@@@%#***+++++========++*#%%%%%%#%%%#####*****##%%%#%#######\n"
    "\t\t+++++++++++++++++++++++**#%%%%%%%###**#%%@@@@%#***+++++======+++###%%%%%#%%##**+++++****++++++++*###\n"
    "\t\t++++++++++++++++++++++****#%%%%%%%####%%%%%%@%#*****+++++++++++*###%%%%%#####*++++*#*++==+****++++**\n"
    "\t\t++++++++++++++***********######*####%%%%%@@%@%###*****+++++++++*####%%%%##%#****##*+++++************\n"
    "\t\t+++++++*****************####****#%##%%#%%%%@%%%####*****++++++**###%%%%%###***##*++++++++++++++++#%#\n"
    "\t\t************##############%%#**###*###%%%*####%#*####********##*#%%%%%%%##***##+++++++++++++++++++*#\n";
    
    std::cout << theme.getBold() << theme.getCalm() << "\n\tWelcome!\n"
        << "\tYou are going to use the best\n"
        <<  "\tphonebook in the world\n"
        <<  "\tby " << theme.getVibr() <<"Svetlana Titovskaia\n"
        << "\n\n\t\t" << girlArt
        << theme.getReset() << std::endl;
}

void PhoneBook::run() {
    std::string choice;
    if (introTimes == 0)
    {
        std::cout << theme.getCalm() << "\n\n\tChoose what you want to do:\n"
        << "\tADD    SEARCH    EXIT\n" << theme.getReset();
    }
    std::cout << theme.getPale();
    getline(std::cin, choice);
    std::cout << theme.getReset();
    if(choice == "EXIT") {
        exit(0);
    } else if(choice == "SEARCH") {
        displayPhoneBook();
        introTimes = 0;
    } else if(choice == "ADD") {
        addContact();
        introTimes = 0;
    } else {
        choice = "CONTINUE";
        introTimes++;
    }
}

PhoneBook::PhoneBook(int a, int b, int c){
    ind  = a;
    count = b;
    introTimes = c;
}
